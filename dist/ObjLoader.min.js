/*! ObjLoader 30-10-2013 */
!function(a,b){"use strict";var c=function(){var a={supported_model_formats:{obj:!0,fbx:!1,dae:!1},getExtension:function(a){var b=a.lastIndexOf(".");return 0>b?"":a.substring(b+1)}};return a.Model=function c(a,b){return this instanceof c?(this.url=a,this.name=b,this.loaded=!1,this.vertices=null,this.texcoords=null,this.normals=null,this.indices=null,this.tangents=null,this.bitangents=null,this.vertexBuffer=null,this.texcoordBuffer=null,this.normalBuffer=null,this.indexBuffer=null,this.tangentBuffer=null,this.bitangentBuffer=null,void 0):new c(a,b)},a.loadModel=function(b,c,d,e){var f,g=a.getExtension(b);if(!a.supported_model_formats[g])return d&&d("File format not supported"),void 0;f=new a.Model(b);var h=new XMLHttpRequest;return h.onprogress=function(a){e&&e(a)},h.onerror=function(a){d&&d("Couldn't fetch model {status="+h.status+"}",a)},h.onload=function(b){if(4!=h.readyState||200!=h.status)return d&&d("Couldn't fetch model {status="+h.status+"}",b),void 0;var e=h.responseText;switch(g){case"obj":a.handleObj(e,f)}c&&c(f)},h.open("GET",b),h.send(),f},a.handleObj=function(c,d){var e,f,g,h,i,j={};for(j.vertices=[],j.normaldata=[],j.normals=[],j.texdata=[],j.texcoords=[],j.indices=[],j.faces=[],j.vertexBuffer=null,j.texcoordBuffer=null,j.normalBuffer=null,j.indexBuffer=null,j.smooth=null,e=0;e<c.length;++e)if("#"!=c[e]){var k="";switch(c[e]){case"v":if(e++,"t"==c[e])for(;++e<c.length;)if(" "==c[e]||"\n"==c[e]){if(k.length>0&&j.texdata.push(parseFloat(k)),k="","\n"==c[e])break}else k+=c[e];else if("n"==c[e]){for(;"\n"!=c[++e]&&e<c.length;)" "==c[e]?(k.length>0&&j.normaldata.push(parseFloat(k)),k=""):k+=c[e];k.length>0&&j.normaldata.push(parseFloat(k))}else{for(;"\n"!=c[++e]&&e<c.length;)" "==c[e]?(k.length>0&&j.vertices.push(parseFloat(k)),k=""):k+=c[e];k.length>0&&j.vertices.push(parseFloat(k))}break;case"s":for(e++;" "==c[e];)++e;"0"==c[e]||"o"==c[e]&&"f"==c[e+1]&&"f"==c[e+2]?(j.smooth=!1,e+=3):"1"==c[e]&&(j.smooth=!0);break;case"f":for(var l={vertices:[],texcoords:[],normals:[]},m=[],n=0;++e<c.length;)if(" "==c[e]||"\n"==c[e]){if(m[0]&&l.vertices.push(parseInt(m[0],10)-1),m[1]&&l.texcoords.push(parseInt(m[1],10)-1),m[2]&&l.normals.push(parseInt(m[2],10)-1),"\n"==c[e])break;m=[],n=0}else"/"==c[e]?++n:(m[n]||(m[n]=""),m[n]+=c[e]);l.vertices.length>0&&j.faces.push(l);break;default:for(;"\n"!=c[e]&&e<c.length;)++e}}else for(;"\n"!=c[++e];);if(j.smooth){var o={};o.vertices=[],o.texcoords=[],o.normals=[],o.indices=[];var p=0;for(e=0;e<j.faces.length;++e){for(f=0;f<j.faces[e].vertices.length;++f)g=j.faces[e].vertices[f],o.vertices.push(j.vertices[3*g]),o.vertices.push(j.vertices[3*g+1]),o.vertices.push(j.vertices[3*g+2]);for(f=0;f<j.faces[e].texcoords.length;++f)h=j.faces[e].texcoords[f],o.texcoords.push(j.texdata[2*h]),o.texcoords.push(j.texdata[2*h+1]);for(f=0;f<j.faces[e].normals.length;++f)i=j.faces[e].normals[f],o.normals.push(j.normaldata[3*i]),o.normals.push(j.normaldata[3*i+1]),o.normals.push(j.normaldata[3*i+2]);for(f=0;f<j.faces[e].vertices.length-2;++f)o.indices.push(p),o.indices.push(p+f+1),o.indices.push(p+f+2);p+=j.faces[e].vertices.length}j.vertices=o.vertices,j.texcoords=o.texcoords,j.normals=o.normals,j.indices=o.indices}else{var q={vertices:[],normals:[],indices:[],texcoords:[]},r=0;for(e=0;e<j.faces.length;++e)if(j.faces[e].vertices.length<3)console.log("Assertion failed: \nLess than 3 vertices in face.");else{for(f=0;f<j.faces[e].vertices.length;++f)g=j.faces[e].vertices[f],q.vertices[3*r]=j.vertices[3*g],q.vertices[3*r+1]=j.vertices[3*g+1],q.vertices[3*r+2]=j.vertices[3*g+2],h=j.faces[e].texcoords[f],h!==b&&(q.texcoords[2*r]=j.texdata[2*h],q.texcoords[2*r+1]=j.texdata[2*h+1]),i=j.faces[e].normals[f],i!==b&&(q.normals[3*r]=j.normaldata[3*i],q.normals[3*r+1]=j.normaldata[3*i+1],q.normals[3*r+2]=j.normaldata[3*i+2]),++r;var s=r-j.faces[e].vertices.length;for(f=0;f<j.faces[e].vertices.length-2;++f)q.indices.push(s),q.indices.push(s+f+1),q.indices.push(s+f+2)}j.vertices=q.vertices,j.texcoords=q.texcoords,j.normals=q.normals,j.indices=q.indices}return d.vertices=j.vertices,d.texcoords=j.texcoords,d.normals=j.normals,d.indices=j.indices,vec3&&vec3.cross&&(a.calculateBitangents(d),vec3.create&&vec3.scale&&vec3.normalize&&vec3.subtract&&a.calculateTangent(d)),d.texcoords.length>0,d.normals.length>0,d.tangents.length>0,d.loaded=!0,d},a.calculateBitangents=function(a){a.bitangents||(a.bitangents=new Array(a.tangents.length));for(var b=0;b<a.indices.length/3;b++){var c=a.indices[3*b],d=a.indices[3*b+1],e=a.indices[3*b+2],f=[a.tangents[3*c],a.tangents[3*c+1],a.tangents[3*c+2]],g=[a.tangents[3*d],a.tangents[3*d+1],a.tangents[3*d+2]],h=[a.tangents[3*e],a.tangents[3*e+1],a.tangents[3*e+2]],i=[a.normals[3*c],a.normals[3*c+1],a.normals[3*c+2]],j=[a.normals[3*d],a.normals[3*d+1],a.normals[3*d+2]],k=[a.normals[3*e],a.normals[3*e+1],a.normals[3*e+2]],l=[0,0,0];vec3.cross(l,[f,g,h],[i,j,k])}},a.calculateTangent=function(a){for(var b=new Array(a.vertices.length),c=0;c<a.vertices.length;c++)b[c]=0;for(a.tangents||(a.tangents=new Array(a.vertices.length)),c=0;c<a.indices.length;c+=3){var d=a.indices[c],e=a.indices[c+1],f=a.indices[c+2],g=[a.vertices[3*d],a.vertices[3*d+1],a.vertices[3*d+2]],h=[a.vertices[3*e],a.vertices[3*e+1],a.vertices[3*e+2]],i=[a.vertices[3*f],a.vertices[3*f+1],a.vertices[3*f+2]],j=[a.texcoords[2*d],a.texcoords[2*d+1]],k=[a.texcoords[2*e],a.texcoords[2*e+1]],l=[a.texcoords[2*f],a.texcoords[2*f+1]],m=h[0]-g[0],n=i[0]-g[0],o=h[1]-g[1],p=i[1]-g[1],q=h[2]-g[2],r=i[2]-g[2],s=k[0]-j[0],t=l[0]-j[0],u=k[1]-j[1],v=l[1]-j[1],w=s*v-t*u,x=1/(0===w)?1:w,y=[(v*m-u*n)*x,(v*o-u*p)*x,(v*q-u*r)*x];b[3*d+0]+=y[0],b[3*d+1]+=y[1],b[3*d+2]+=y[2],b[3*e+0]+=y[0],b[3*e+1]+=y[1],b[3*e+2]+=y[2],b[3*f+0]+=y[0],b[3*f+1]+=y[1],b[3*f+2]+=y[2]}for(c=0;c<a.vertices.length;c+=3){var z=[a.normals[c],a.normals[c+1],a.normals[c+2]],A=[b[c],b[c+1],b[c+2]],B=vec3.dot(z,A);vec3.scale(z,z,B);var C=vec3.create();vec3.subtract(C,A,z),vec3.normalize(C,C),a.tangents[c]=C[0],a.tangents[c+1]=C[1],a.tangents[c+2]=C[2]}},a}();c.VERSION="0.0.0",a.ObjLoader=c}(this);